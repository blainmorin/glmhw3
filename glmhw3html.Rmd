---
title: 'PHP 2514 Homework #3'
author: "Blain Morin"
date: "March 19, 2018"
output: html_document
---

#Question 1:

Assume X is in units of $10,000.

First, find y-intercept ($\beta_0$):

$$
\begin{align}
\pi &= .27\\
x &= 0\\
logit(.27) &= \ln(\frac{.27}{1-.27}) = \beta_0 + \beta_1X\\
-.9946 &= \beta_0
\end{align}
$$

Next, find the slope ($\beta_1$):

$$
\begin{align}
\pi &= .88 \\
x &= 6 \\
logit(.88) &=\ln(\frac{.88}{1-.88}) = -.9946 +\beta_1 *6\\
.4978 &= \beta_1
\end{align}
$$

Thus, the equation is:

$$
\pi = logit^{-1}(-.9946 + .4978X)
$$

#Question 2

##a.)
```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(arm)

###create data set
studentid = 1:50
set.seed(50)
grades = rnorm(50, 60, 15)

###use the our logit to predict if a student passed using their midterm grade
prob.pass = c()
for (i in 1:50) {
  
  prob = invlogit(-24 + .4 * grades[i])
  prob.pass[i] = rbinom(1, 1, prob = prob)
  
}

classdata = data.frame(studentid, grades, prob.pass)



###graph our points with the logit function given by the problem
classdata %>%
  ggplot(aes(x = grades, y = prob.pass)) + 
    stat_function(fun = function(x) invlogit(-24 + .4*x), color = "aquamarine3", size = 2) +
    geom_point(size = 3.5, alpha = .4, color = "coral3") + 
    theme_minimal() +
    xlab("Midterm Grade") +
    ylab("Pr(pass)") +
    ggtitle("Passed class vs Midterm Grade")
  
```

##b.)

```{r}

###Add a column with standardized grades
classdata = classdata %>%
  mutate(stand.grade = (grades - mean(grades)) / sd(grades))


###Plot our standardized data with our updated logit curve
###To get our new logit function we multiplied the B0 by 0
###and multiplied B1 by 15
classdata %>%
    ggplot(aes(x = stand.grade, y = prob.pass)) + 
    stat_function(fun = function(x) invlogit((-24*0) + (.4*15)*x), color = "aquamarine3", size = 2) +
    geom_point(size = 3.5, alpha = .4, color = "coral3") + 
    theme_minimal() +
    xlab("Standardized Grade") +
    ylab("Pr(pass)") +
    ggtitle("Pr(Pass) vs Standardized Grade")

```


##c.)

```{r, message = FALSE, warning=FALSE}
library(sjPlot)
attach(classdata)

###Add random noise column to our data
noise = rnorm(50, 0 , 1)
classdata$noise = noise

###Run model with no noise
model.no.noise = glm(prob.pass ~ stand.grade, family = binomial(link = "logit"))


###Run model with noise
model.noise = glm(prob.pass ~ stand.grade + noise, family = binomial(link = "logit"))


print(c(model.no.noise$deviance, model.noise$deviance))

detach(classdata)

```

The deviance in our noise model is very similar to the deviance in the first model (20.93 vs 20.74. This makes sense theoretically: since the noise is randomly generated, it shouldn't impact the fit of our model (except for some random spurious correlation). Thus, our residuals will not change much. Therefore, the deviance will not change much. 


#Question 3


##a.)

First we examined the histogram for our race categories. 

```{r}

rodents = read.table("rodents.txt")
rodents$rodent2 = as.factor(rodents$rodent2)
rodents$race = as.factor(rodents$race)


hist(as.numeric(rodents$race))
```

We see that race indicators 6 and 7 have a low frequency, so we will bin those together: 

```{r}

###Combine race 6 and 7 into category 6. 

race.edit = c()

for (i in 1:nrow(rodents)) {
  if (rodents$race[i] == 7) {
    race.edit[i] = 6
  } else {
    race.edit[i] = rodents$race[i]
  }
}

rodents$race.edit = as.factor(race.edit)

base.model = glm(formula = rodent2 ~ race.edit,
                 family = binomial(link = "logit"), 
                 data = rodents)

```

```{r, include = FALSE}

summary(base.model)

stargazer::stargazer(base.model, type = "html")

```

<table style="text-align:center"><tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"></td><td><em>Dependent variable:</em></td></tr>
<tr><td></td><td colspan="1" style="border-bottom: 1px solid black"></td></tr>
<tr><td style="text-align:left"></td><td>rodent2</td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">race.edit2</td><td>1.536<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.169)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">race.edit3</td><td>1.449<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.214)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">race.edit4</td><td>1.867<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.187)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">race.edit5</td><td>0.400</td></tr>
<tr><td style="text-align:left"></td><td>(0.292)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">race.edit6</td><td>1.364<sup>**</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.554)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">Constant</td><td>-2.152<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.128)</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">Observations</td><td>1,522</td></tr>
<tr><td style="text-align:left">Log Likelihood</td><td>-760.124</td></tr>
<tr><td style="text-align:left">Akaike Inf. Crit.</td><td>1,532.248</td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"><em>Note:</em></td><td style="text-align:right"><sup>*</sup>p<0.1; <sup>**</sup>p<0.05; <sup>***</sup>p<0.01</td></tr>
</table>

In the output above, race 1 is our reference category. Raising e to the beta is the multiplicitive change in the odds of having rodents in the apartment. For example, for race category 2: 

```{r}

exp(1.536)

```

This is interpretted as: 

Compared to race category 1, the odds of having rodents in the apartment is 4.6 times higher for those people in race category 2. 

##b.)

Next, we try to find a good model using other other house-hold level variables. The variables that I'm choosing to examine are:

- Rotted / Broken Windows
- Missing or Worn Flooring
- Cracks in Walls
- Holes in the flooring
- If the building was built before 1947
- If there is a regular exterminator
- Total household income
- Housing type (rent, public housing, owned)

```{r, message=FALSE, results="hide"}

attach(rodents)

b.data = data.frame(
  as.factor(rodent2),
  as.factor(extwin4_2),
  as.factor(extflr5_2),
  as.factor(intcrack2),
  as.factor(inthole2),
  as.factor(old),
  as.factor(race.edit),
  as.factor(regext),
  totincom2
)

detach(rodents)

attach(b.data)

###change income units to thousand
b.data$totincom2 = b.data$totincom2/10000

###remove NAs
b.data = na.omit(b.data)

b.model = glm(as.factor.rodent2. ~ ., family = binomial(link="logit"), data = b.data)

b.step.model = step(b.model, direction = "both")

```

```{r, echo=FALSE}
sjt.glm(b.step.model)
```

The odds ratios for all of the variables are given in the above table. The interpretation of these is similar to part(a). For example, having a hole in the floor of the apartment means that there is 2.88 times the odds of having rodents than in an apartment with no holes in the floor. The interpretation is similar for income: a household earning 1000 dollars more than another similar household has .95 times the odds of having rodents. 

Overall, most of the variables in our model are significant at the 5 percent level. The signs of the household factors are consistent with what one would expect (ie holes in the floor is associated with higher odds of having rats). The variables that the model dropped were having a regular exterminator and having a crack in the exterior windows. 

Next we checked the fit using residual diagnostics. First, we compared the residuals and fitted values:
```{r}

plot(fitted(b.step.model), resid(b.step.model))
lines(lowess(predict(b.step.model),residuals(b.step.model)),col="black",lwd=2)

```

Since this is a logistic regression, we see two groups of points. The black line is a regression on the points. We see that this line is fairly close to the 0 line, which means that there is no pattern in our residuals. We can examine the residuals further using a bin plot:

```{r, warning=FALSE}

library(arm)
binnedplot(predict.glm(b.step.model), resid(b.step.model))

```

The grey lines represent the 95% confidence interval for the residuals assuming that the model was true. We see that the model is mostly okay, but that there are a few point in the lower expected values that fall outside of the confidence interval. This could be a problem with the model. We would maybe need to add a quadratic term or use a log transformation. 

We also looked at the ROC curve:

```{r, warning=FALSE}

library(ModelGood)
plot(Roc(b.step.model), auc = TRUE)


```

As seen above, the area under our ROC curve is .77. This means that our model does a decent job of discriminating between apartments with and without rodents. 

Next we looked at a calibration curve for our model:

```{r}

calPlot2(b.step.model)

```

We can see from the calibration plot that our model predicts the observed probability closely up to probabilities of .6. Above .6, our model underestimates. 


#Question 4

For our first model, we use only the clinical variables. Since our outcome (dehydration) is an ordinal factor, we use a cumulative logit model. 

```{r, message=FALSE, warning=FALSE}

library(readr)
library(nnet)
library(VGAM)
library(sjPlot)

###Select clinical only columns
dhaka = read_csv("dhaka.csv")
clinicaldata = dhaka[, 1:13]

###Change columns to factors
clinicaldata = lapply(clinicaldata, as.factor)
clinicaldata = as.data.frame(clinicaldata)

###Run regression for only clinical predictors
model.clinical = multinom(ordered(dehyd) ~ capref +
                        extrem +
                        eyes +
                        genapp +
                        mucous +
                        pulse +
                        resp + 
                        skin +
                        tears +
                        thirst +
                        urine +
                        heart,
                      family = cumulative(parallel = FALSE),
                      data = clinicaldata)

summary(model.clinical)

```

```{r, echo = FALSE, include=FALSE}

clinical.table = xtable::xtable(coef(summary(model.clinical)))
print(clinical.table, type = "html")

```

<table border=1>
<tr> <th>  </th> <th> Estimate </th> <th> Std. Error </th> <th> z value </th> <th> Pr(&gt;|z|) </th>  </tr>
  <tr> <td align="right"> (Intercept):1 </td> <td align="right"> 0.73 </td> <td align="right"> 0.96 </td> <td align="right"> 0.76 </td> <td align="right"> 0.45 </td> </tr>
  <tr> <td align="right"> (Intercept):2 </td> <td align="right"> 3.88 </td> <td align="right"> 0.99 </td> <td align="right"> 3.94 </td> <td align="right"> 0.00 </td> </tr>
  <tr> <td align="right"> capref1 </td> <td align="right"> 0.30 </td> <td align="right"> 2.10 </td> <td align="right"> 0.14 </td> <td align="right"> 0.89 </td> </tr>
  <tr> <td align="right"> extrem1 </td> <td align="right"> -0.36 </td> <td align="right"> 0.50 </td> <td align="right"> -0.72 </td> <td align="right"> 0.47 </td> </tr>
  <tr> <td align="right"> eyes1 </td> <td align="right"> -0.25 </td> <td align="right"> 0.35 </td> <td align="right"> -0.71 </td> <td align="right"> 0.48 </td> </tr>
  <tr> <td align="right"> eyes2 </td> <td align="right"> -1.06 </td> <td align="right"> 0.52 </td> <td align="right"> -2.06 </td> <td align="right"> 0.04 </td> </tr>
  <tr> <td align="right"> genapp1 </td> <td align="right"> -0.49 </td> <td align="right"> 0.29 </td> <td align="right"> -1.69 </td> <td align="right"> 0.09 </td> </tr>
  <tr> <td align="right"> genapp2 </td> <td align="right"> -1.13 </td> <td align="right"> 0.34 </td> <td align="right"> -3.27 </td> <td align="right"> 0.00 </td> </tr>
  <tr> <td align="right"> heart1 </td> <td align="right"> -0.34 </td> <td align="right"> 0.27 </td> <td align="right"> -1.26 </td> <td align="right"> 0.21 </td> </tr>
  <tr> <td align="right"> heart2 </td> <td align="right"> -16.19 </td> <td align="right"> 906.99 </td> <td align="right"> -0.02 </td> <td align="right"> 0.99 </td> </tr>
  <tr> <td align="right"> mucous1 </td> <td align="right"> 0.01 </td> <td align="right"> 0.27 </td> <td align="right"> 0.04 </td> <td align="right"> 0.97 </td> </tr>
  <tr> <td align="right"> mucous2 </td> <td align="right"> 15.95 </td> <td align="right"> 907.00 </td> <td align="right"> 0.02 </td> <td align="right"> 0.99 </td> </tr>
  <tr> <td align="right"> pulse1 </td> <td align="right"> -0.54 </td> <td align="right"> 0.31 </td> <td align="right"> -1.73 </td> <td align="right"> 0.08 </td> </tr>
  <tr> <td align="right"> pulse2 </td> <td align="right"> -0.47 </td> <td align="right"> 0.47 </td> <td align="right"> -1.01 </td> <td align="right"> 0.31 </td> </tr>
  <tr> <td align="right"> resp1 </td> <td align="right"> -0.04 </td> <td align="right"> 0.30 </td> <td align="right"> -0.15 </td> <td align="right"> 0.88 </td> </tr>
  <tr> <td align="right"> resp2 </td> <td align="right"> -0.27 </td> <td align="right"> 0.87 </td> <td align="right"> -0.31 </td> <td align="right"> 0.76 </td> </tr>
  <tr> <td align="right"> skin1 </td> <td align="right"> -0.85 </td> <td align="right"> 0.27 </td> <td align="right"> -3.10 </td> <td align="right"> 0.00 </td> </tr>
  <tr> <td align="right"> skin2 </td> <td align="right"> -0.80 </td> <td align="right"> 0.59 </td> <td align="right"> -1.36 </td> <td align="right"> 0.17 </td> </tr>
  <tr> <td align="right"> tears1 </td> <td align="right"> -0.24 </td> <td align="right"> 0.26 </td> <td align="right"> -0.92 </td> <td align="right"> 0.36 </td> </tr>
  <tr> <td align="right"> tears2 </td> <td align="right"> -0.77 </td> <td align="right"> 0.46 </td> <td align="right"> -1.69 </td> <td align="right"> 0.09 </td> </tr>
  <tr> <td align="right"> thirst1 </td> <td align="right"> 0.52 </td> <td align="right"> 0.91 </td> <td align="right"> 0.57 </td> <td align="right"> 0.57 </td> </tr>
  <tr> <td align="right"> thirst2 </td> <td align="right"> 0.37 </td> <td align="right"> 0.98 </td> <td align="right"> 0.37 </td> <td align="right"> 0.71 </td> </tr>
  <tr> <td align="right"> urine1 </td> <td align="right"> -0.34 </td> <td align="right"> 0.26 </td> <td align="right"> -1.32 </td> <td align="right"> 0.19 </td> </tr>
  <tr> <td align="right"> urine2 </td> <td align="right"> -0.01 </td> <td align="right"> 0.37 </td> <td align="right"> -0.04 </td> <td align="right"> 0.97 </td> </tr>
   </table>

We see from the results above that not all the predictors are significant at the 5% level. For example, general appearance is highly significant, whereas mucous seem to have no predictive value. Raising e to the beta estimates is interpretted as the decrease in the odds of being not dehydrated. For example, for the having poor general appearance coefficient (category 2):

```{r}

exp(-1.2)

```

In other words, the odds of not being dehydrated for people with poor general appearance is .323 time the odds of not being dehydrated for people with good general appearance. 


```{r}

###Attach non-clilnical predictors to our as factor clinical predictors
nonclinical = dhaka[,14:20]

alldata = cbind(clinicaldata, nonclinical)

model.all = vglm(ordered(dehyd) ~ .,
                 family = cumulative(parallel = TRUE),
                 data = alldata)

summary(model.all)
```

<table style="text-align:center"><tr><td colspan="3" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"></td><td colspan="2"><em>Dependent variable:</em></td></tr>
<tr><td></td><td colspan="2" style="border-bottom: 1px solid black"></td></tr>
<tr><td style="text-align:left"></td><td>1</td><td>2</td></tr>
<tr><td style="text-align:left"></td><td>(1)</td><td>(2)</td></tr>
<tr><td colspan="3" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">capref</td><td>11.605<sup>***</sup></td><td>-5.306<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.00000)</td><td>(0.000)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">extrem</td><td>0.158</td><td>0.628</td></tr>
<tr><td style="text-align:left"></td><td>(0.869)</td><td>(0.943)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">eyes</td><td>0.262</td><td>0.867<sup>*</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.310)</td><td>(0.474)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">genapp</td><td>0.600<sup>***</sup></td><td>0.887<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.208)</td><td>(0.283)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">heart</td><td>0.597<sup>*</sup></td><td>0.329</td></tr>
<tr><td style="text-align:left"></td><td>(0.330)</td><td>(0.449)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">mucous</td><td>-0.180</td><td>0.325</td></tr>
<tr><td style="text-align:left"></td><td>(0.297)</td><td>(0.540)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">pulse</td><td>0.673<sup>**</sup></td><td>0.692<sup>*</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.330)</td><td>(0.393)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">resp</td><td>0.489</td><td>0.241</td></tr>
<tr><td style="text-align:left"></td><td>(0.368)</td><td>(0.479)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">skin</td><td>0.873<sup>***</sup></td><td>0.853<sup>**</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.292)</td><td>(0.417)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">tears</td><td>0.083</td><td>0.455</td></tr>
<tr><td style="text-align:left"></td><td>(0.258)</td><td>(0.356)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">thirst</td><td>-0.489</td><td>0.238</td></tr>
<tr><td style="text-align:left"></td><td>(0.509)</td><td>(0.613)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">urine</td><td>0.073</td><td>0.196</td></tr>
<tr><td style="text-align:left"></td><td>(0.211)</td><td>(0.330)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td style="text-align:left">Constant</td><td>-0.796</td><td>-4.547<sup>***</sup></td></tr>
<tr><td style="text-align:left"></td><td>(0.586)</td><td>(0.855)</td></tr>
<tr><td style="text-align:left"></td><td></td><td></td></tr>
<tr><td colspan="3" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">Akaike Inf. Crit.</td><td>645.875</td><td>645.875</td></tr>
<tr><td colspan="3" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"><em>Note:</em></td><td colspan="2" style="text-align:right"><sup>*</sup>p<0.1; <sup>**</sup>p<0.05; <sup>***</sup>p<0.01</td></tr>
</table>

